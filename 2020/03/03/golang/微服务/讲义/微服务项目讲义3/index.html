<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="微服务," />










<meta name="description" content="1.session功能实现">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务相关知识3">
<meta property="og:url" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/index.html">
<meta property="og:site_name" content="极风键客">
<meta property="og:description" content="1.session功能实现">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1542889467165.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543151932045.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543150703766.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543150684587.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543152066379.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543152217047.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543152417782.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543152506873.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543153060818.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543153360870.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543153464298.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543153705596.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543154107047.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543154391621.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543154867892.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543155051108.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543155208535.jpg">
<meta property="og:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1543156498014.jpg">
<meta property="article:published_time" content="2020-03-03T12:46:25.000Z">
<meta property="article:modified_time" content="2021-07-15T09:57:46.091Z">
<meta property="article:author" content="王增明">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/assets%5Cclip_image002-1542889467165.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: false,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2020/03/03/golang/微服务/讲义/微服务项目讲义3/"/>





  <title>微服务相关知识3 | 极风键客</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">极风键客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%893/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/i.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="极风键客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">微服务相关知识3</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-03T20:46:25+08:00">
                2020-03-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang/" itemprop="url" rel="index">
                    <span itemprop="name">golang</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-session功能实现"><a href="#1-session功能实现" class="headerlink" title="1.session功能实现"></a>1.session功能实现</h1><span id="more"></span>

<h2 id="1-1业务流程图"><a href="#1-1业务流程图" class="headerlink" title="1.1业务流程图"></a>1.1业务流程图</h2><p><img src="assets%5Cclip_image002-1542889467165.jpg" alt="111"></p>
<h2 id="1-2接口定义"><a href="#1-2接口定义" class="headerlink" title="1.2接口定义"></a>1.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">url:api/v1<span class="number">.0</span>/session</span><br><span class="line">data:no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;OK&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;<span class="attr">&quot;name&quot;</span> : <span class="string">&quot;13313331333&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#注册失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3具体业务实现"><a href="#1-3具体业务实现" class="headerlink" title="1.3具体业务实现"></a>1.3具体业务实现</h2><p>session的处理，我们可以直接放在web端来实现，具体实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义返回数据容器</span></span><br><span class="line">resp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">dataTmp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"><span class="comment">//初始化session</span></span><br><span class="line">s := sessions.Default(ctx)</span><br><span class="line">userName := s.Get(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//对获取的session校验</span></span><br><span class="line"><span class="keyword">if</span> userName == <span class="literal">nil</span>&#123;</span><br><span class="line">    <span class="comment">//初始化返回值</span></span><br><span class="line">    resp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SESSIONERR</span><br><span class="line">    resp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SESSIONERR)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    resp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_OK</span><br><span class="line">    resp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">    dataTmp[<span class="string">&quot;name&quot;</span>] = userName.(<span class="keyword">string</span>)</span><br><span class="line">    resp[<span class="string">&quot;data&quot;</span>] = dataTmp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.JSON(<span class="number">200</span>,resp)</span><br></pre></td></tr></table></figure>

<h1 id="2-用户信息展示"><a href="#2-用户信息展示" class="headerlink" title="2.用户信息展示"></a>2.用户信息展示</h1><h2 id="2-1业务流程图"><a href="#2-1业务流程图" class="headerlink" title="2.1业务流程图"></a>2.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543151932045.jpg" alt="im"></p>
<h2 id="2-2接口定义"><a href="#2-2接口定义" class="headerlink" title="2.2接口定义"></a>2.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">url:api/v1<span class="number">.0</span>/user</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;itcast&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mobile&quot;</span>: <span class="string">&quot;110&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;real_name&quot;</span>: <span class="string">&quot;传智&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;id_card&quot;</span>: <span class="string">&quot;210112244556677&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:8888/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3服务端实现"><a href="#2-3服务端实现" class="headerlink" title="2.3服务端实现"></a>2.3服务端实现</h2><p>首先我们根据接口定义来确定proto文件的参数，修改后的proto文件如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> go.micro.srv.getUserInfo;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">GetUserInfo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Call(Request) <span class="keyword">returns</span> (Response) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    UserData data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">UserData</span></span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> user_id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">string</span> real_name = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">string</span> id_card = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">string</span> avatar_url = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改main.go文件，再详细的实现我们的业务方法，具体代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据用户名获取信息</span></span><br><span class="line">db ,err:= model.InitDb()</span><br><span class="line">user,err := model.GetUserInfo(db,req.Name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    rsp.Errno = utils.RECODE_DBERR</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data getUserInfo.UserData</span><br><span class="line"></span><br><span class="line">data.Name = user.Name</span><br><span class="line">data.Mobile = user.Mobile</span><br><span class="line">data.IdCard = user.Id_card</span><br><span class="line">data.RealName = user.Real_name</span><br><span class="line">data.AvatarUrl = user.Avatar_url</span><br><span class="line">data.UserId  = <span class="keyword">int32</span>(user.ID)</span><br><span class="line"></span><br><span class="line">rsp.Errno = utils.RECODE_OK</span><br><span class="line">rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">rsp.Data  = &amp;data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意函数的封装，封装的函数如下：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据用户名获取当前用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfo</span><span class="params">(db*gorm.DB,name <span class="keyword">string</span>)</span><span class="params">(User,error)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    err := db.Where(<span class="string">&quot;name = ?&quot;</span>,name).First(&amp;user).Error</span><br><span class="line">    <span class="keyword">return</span> user,err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4web端实现"><a href="#2-4web端实现" class="headerlink" title="2.4web端实现"></a>2.4web端实现</h2><p>服务端实现之后，接着我们来实现web端，首先我们要匹配相应的路由，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.GET(<span class="string">&quot;/user&quot;</span>,controller.GetUserInfo)</span><br></pre></td></tr></table></figure>

<p>然后实现具体的控制器函数，首先是从session中获取数据，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取登录信息</span></span><br><span class="line">    s := sessions.Default(ctx)</span><br><span class="line">    userName := s.Get(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> userName == <span class="literal">nil</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SESSIONERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SESSIONERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后调用远程服务，把用户名传到远程，并获取返回值，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//远程调用</span></span><br><span class="line">grpcService := utils.GetGrpcService()</span><br><span class="line">client := getUserInfo.NewGetUserInfoService(<span class="string">&quot;go.micro.srv.getUserInfo&quot;</span>,grpcService.Client())</span><br><span class="line">resp,err := client.Call(context.TODO(),&amp;getUserInfo.Request&#123;Name:userName.(<span class="keyword">string</span>)&#125;)</span><br></pre></td></tr></table></figure>

<p>根据返回值确定返回给前端的数据，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        resp.Errno = utils.RECODE_DBERR</span><br><span class="line">        resp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br></pre></td></tr></table></figure>

<h1 id="3-退出登陆"><a href="#3-退出登陆" class="headerlink" title="3.退出登陆"></a>3.退出登陆</h1><h2 id="3-1业务流程图"><a href="#3-1业务流程图" class="headerlink" title="3.1业务流程图"></a>3.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543150703766.jpg" alt="mg"></p>
<h2 id="3-2接口定义"><a href="#3-2接口定义" class="headerlink" title="3.2接口定义"></a>3.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: DELETE</span><br><span class="line">url:api/v1<span class="number">.0</span>/session</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;OK&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3业务实现"><a href="#3-3业务实现" class="headerlink" title="3.3业务实现"></a>3.3业务实现</h2><p>退出登陆实现比较简单，直接删除session即可，首先我们来匹配一下路由，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.DELETE(<span class="string">&quot;/session&quot;</span>,controller.DeleteSession)</span><br></pre></td></tr></table></figure>

<p>然后在控制器实现删除session返回数据操作，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeleteSession</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line">    resp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除session</span></span><br><span class="line">    s := sessions.Default(ctx)</span><br><span class="line">    s.Delete(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line">    err := s.Save()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        resp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SESSIONERR</span><br><span class="line">        resp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SESSIONERR)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        resp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_OK</span><br><span class="line">        resp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意。不管是设置session还是删除session最后都需要调用save方法。</p>
</blockquote>
<h1 id="4-登陆业务实现"><a href="#4-登陆业务实现" class="headerlink" title="4.登陆业务实现"></a>4.登陆业务实现</h1><h2 id="4-1业务流程图"><a href="#4-1业务流程图" class="headerlink" title="4.1业务流程图"></a>4.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543150684587.jpg" alt="im"></p>
<h2 id="4-2接口定义"><a href="#4-2接口定义" class="headerlink" title="4.2接口定义"></a>4.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">url:api/v1<span class="number">.0</span>/sessions</span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line">    mobile: <span class="string">&quot;133&quot;</span>, <span class="comment">//手机号</span></span><br><span class="line">    password: <span class="string">&quot;itcast&quot;</span><span class="comment">//密码</span></span><br><span class="line">&#125;</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;OK&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3服务端实现"><a href="#4-3服务端实现" class="headerlink" title="4.3服务端实现"></a>4.3服务端实现</h2><p>首先是创建服务，代码如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> src project/login</span></span><br></pre></td></tr></table></figure>

<p>然后根据接口定义，修改proto参数，修改后的proto内容如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> go.micro.srv.login;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Call(Request) <span class="keyword">returns</span> (Response) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> mobile = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> password = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编译proto文件，生成对应接口，修改Main.go文件，再具体实现登陆业务，登陆业务实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化mysql连接    </span></span><br><span class="line">db,err := model.InitDb()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    rsp.Errno = utils.RECODE_DBERR</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对传入的密码进行md5加密，然后调用封装的函数进行登陆校验，注意后面需要把用户名存入session,所以要把name传出</span></span><br><span class="line">m5 := md5.New()</span><br><span class="line">m5.Write([]<span class="keyword">byte</span>(req.Password))</span><br><span class="line">pwdHash := hex.EncodeToString(m5.Sum(<span class="literal">nil</span>))</span><br><span class="line">result,name := model.GetLoginInfo(db,req.Mobile,pwdHash)</span><br><span class="line"><span class="comment">//根据结果返回数据</span></span><br><span class="line"><span class="keyword">if</span> result&#123;</span><br><span class="line">    rsp.Errno = utils.RECODE_OK</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">    rsp.Name = name</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    rsp.Errno = utils.RECODE_DATAERR</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_DATAERR)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>封装的函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据电话号和密码判断,登录是否成功</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLoginInfo</span><span class="params">(db *gorm.DB,mobile <span class="keyword">string</span>,pwd <span class="keyword">string</span>)</span><span class="params">(<span class="keyword">bool</span>,<span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    db.Where(<span class="string">&quot;mobile = ?&quot;</span>,mobile).First(&amp;user)</span><br><span class="line">    <span class="keyword">return</span> user.Password_hash == pwd,user.Name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-4web端实现"><a href="#4-4web端实现" class="headerlink" title="4.4web端实现"></a>4.4web端实现</h2><p>处理完服务端接着我们来处理web端内容， 首先是做路由匹配，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.POST(<span class="string">&quot;/sessions&quot;</span>,controller.PostLogin)</span><br></pre></td></tr></table></figure>

<p>然后在具体控制器函数中实现登陆业务，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//登录处理</span></span><br><span class="line"><span class="keyword">type</span> UserLogin <span class="keyword">struct</span> &#123;</span><br><span class="line">    Mobile <span class="keyword">string</span> <span class="string">`json:&quot;mobile&quot;`</span></span><br><span class="line">    Password <span class="keyword">string</span> <span class="string">`json:&quot;password&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostLogin</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line">    <span class="comment">//定义错误容器</span></span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    <span class="keyword">var</span> userLogin UserLogin</span><br><span class="line">    err := ctx.Bind(&amp;userLogin)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_REQERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_REQERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程服务调用</span></span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := login.NewLoginService(<span class="string">&quot;go.micro.srv.login&quot;</span>,grpcService.Client())</span><br><span class="line">    resp,err := client.Call(context.TODO(),&amp;login.Request&#123;Mobile:userLogin.Mobile,Password:userLogin.Password&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_LOGINERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_LOGINERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果返回成功,存储session</span></span><br><span class="line">    <span class="keyword">if</span> resp.Errno == utils.RECODE_OK&#123;</span><br><span class="line">        s := sessions.Default(ctx)</span><br><span class="line">        s.Set(<span class="string">&quot;userName&quot;</span>,resp.Name)</span><br><span class="line">        s.Save()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-上传用户头像业务"><a href="#5-上传用户头像业务" class="headerlink" title="5.上传用户头像业务"></a>5.上传用户头像业务</h1><h2 id="5-1业务流程图"><a href="#5-1业务流程图" class="headerlink" title="5.1业务流程图"></a>5.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543152066379.jpg" alt="im"></p>
<h2 id="5-2接口定义"><a href="#5-2接口定义" class="headerlink" title="5.2接口定义"></a>5.2接口定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/avatar</span><br><span class="line">#data:</span><br><span class="line">图片的二进制数据</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avatar_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:8888/group1/M00/00/00/Zciqq1n6_L-AOB04AADexS5wJKs662.png&quot;</span> <span class="comment">//图片地址需要进行拼接</span></span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="string">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3服务端实现"><a href="#5-3服务端实现" class="headerlink" title="5.3服务端实现"></a>5.3服务端实现</h2><p>首先创建服务。命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> srv project/postAva</span></span><br></pre></td></tr></table></figure>

<p>然后根据接口定义确定proto文件内容，proto文件内容如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> go.micro.srv.postAvatar;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">PostAvatar</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Call(Request) <span class="keyword">returns</span> (Response) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">bytes</span> file = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> fileExt = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    ImgPath data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">ImgPath</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> avatar_url = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里注意，我们把文件存储的时候需要获取文件格式信息，所系需要把文件格式传递过来，头像信息上传之后需要和当前用户绑定，所以需要把用户名传递过来。</p>
</blockquote>
<p>然后编译proto并修改main.go文件，再去handler中实现具体业务，业务代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析出来文件</span></span><br><span class="line">client ,_:= fdfs_client.NewFdfsClient(<span class="string">&quot;/etc/fdfs/client.conf&quot;</span>)</span><br><span class="line"></span><br><span class="line">uploadResp ,err := client.UploadByBuffer(req.File,req.FileExt)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    rsp.Errno = utils.RECODE_IOERR</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_IOERR)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//给返回值赋值</span></span><br><span class="line">rsp.Errno = utils.RECODE_OK</span><br><span class="line">rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line"><span class="keyword">var</span> imgPath postAvatar.ImgPath</span><br><span class="line">imgPath.AvatarUrl = <span class="string">&quot;http://192.168.137.130:8888/&quot;</span>+uploadResp.RemoteFileId</span><br><span class="line"></span><br><span class="line">rsp.Data = &amp;imgPath</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<h2 id="5-4web端实现"><a href="#5-4web端实现" class="headerlink" title="5.4web端实现"></a>5.4web端实现</h2><p>具体实现，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostAvatar</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义错误返回容器</span></span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取前段传递的文件</span></span><br><span class="line">    fileHeader ,err:= ctx.FormFile(<span class="string">&quot;avatar&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_REQERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_REQERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件大小及格式是否正确</span></span><br><span class="line">    <span class="keyword">if</span> fileHeader.Size &gt; <span class="number">500000</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_DATAERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_DATAERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fileExt:= path.Ext(fileHeader.Filename)</span><br><span class="line">    <span class="keyword">if</span> fileExt != <span class="string">&quot;.jpg&quot;</span> &amp;&amp; fileExt != <span class="string">&quot;.png&quot;</span> &amp;&amp; fileExt != <span class="string">&quot;.jpeg&quot;</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_DATAERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_DATAERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取文件流,并写成字节格式</span></span><br><span class="line">    file ,_ :=fileHeader.Open()</span><br><span class="line">    buffer := <span class="built_in">make</span>([]<span class="keyword">byte</span>,fileHeader.Size)</span><br><span class="line">    file.Read(buffer)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取用户名</span></span><br><span class="line">    s := sessions.Default(ctx)</span><br><span class="line">    userName := s.Get(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用远程服务</span></span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := postAva.NewPostAvatarService(<span class="string">&quot;go.micro.srv.postAvatar&quot;</span>,grpcService.Client())</span><br><span class="line">    resp ,err:= client.Call(context.TODO(),&amp;postAva.Request&#123;</span><br><span class="line">        FileExt:fileExt,</span><br><span class="line">        File:buffer,</span><br><span class="line">        Name:userName.(<span class="keyword">string</span>),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_IOERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_IOERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-更新用户名"><a href="#6-更新用户名" class="headerlink" title="6.更新用户名"></a>6.更新用户名</h1><h2 id="6-1业务流程图"><a href="#6-1业务流程图" class="headerlink" title="6.1业务流程图"></a>6.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543152217047.jpg" alt="im"></p>
<h2 id="6-2接口定义"><a href="#6-2接口定义" class="headerlink" title="6.2接口定义"></a>6.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: PUT</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/name</span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;panda&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Panda&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3服务端实现"><a href="#6-3服务端实现" class="headerlink" title="6.3服务端实现"></a>6.3服务端实现</h2><h2 id="6-4web端实现"><a href="#6-4web端实现" class="headerlink" title="6.4web端实现"></a>6.4web端实现</h2><h1 id="7-检查用户实名认证"><a href="#7-检查用户实名认证" class="headerlink" title="7.检查用户实名认证"></a>7.检查用户实名认证</h1><h2 id="7-1业务流程图"><a href="#7-1业务流程图" class="headerlink" title="7.1业务流程图"></a>7.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543152417782.jpg" alt="im"></p>
<h2 id="7-2接口定义"><a href="#7-2接口定义" class="headerlink" title="7.2接口定义"></a>7.2接口定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/auth</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Panda&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123123&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mobile&quot;</span>: <span class="string">&quot;110&quot;</span>,</span><br><span class="line">    <span class="string">&quot;real_name&quot;</span>: <span class="string">&quot;熊猫&quot;</span>,</span><br><span class="line">    <span class="string">&quot;id_card&quot;</span>: <span class="string">&quot;210112244556677&quot;</span>,</span><br><span class="line">    <span class="string">&quot;avatar_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="string">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-3服务端实现"><a href="#7-3服务端实现" class="headerlink" title="7.3服务端实现"></a>7.3服务端实现</h2><h2 id="7-4web端实现"><a href="#7-4web端实现" class="headerlink" title="7.4web端实现"></a>7.4web端实现</h2><h1 id="8-更新用户实名认证"><a href="#8-更新用户实名认证" class="headerlink" title="8.更新用户实名认证"></a>8.更新用户实名认证</h1><h2 id="8-1业务流程图"><a href="#8-1业务流程图" class="headerlink" title="8.1业务流程图"></a>8.1业务流程图</h2><p><img src="assets%5Cclip_image002-1543152506873.jpg" alt="im"></p>
<h2 id="8-2接口定义"><a href="#8-2接口定义" class="headerlink" title="8.2接口定义"></a>8.2接口定义</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/auth</span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line">    real_name: <span class="string">&quot;熊猫&quot;</span>, </span><br><span class="line">    id_card: <span class="string">&quot;21011223344556677&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3服务端实现"><a href="#8-3服务端实现" class="headerlink" title="8.3服务端实现"></a>8.3服务端实现</h2><h2 id="8-4web端实现"><a href="#8-4web端实现" class="headerlink" title="8.4web端实现"></a>8.4web端实现</h2><h1 id="9-获取当前用户已发布房源信息"><a href="#9-获取当前用户已发布房源信息" class="headerlink" title="9 获取当前用户已发布房源信息"></a>9 获取当前用户已发布房源信息</h1><p>获取用户已发布房源信息服务（商品相关）</p>
<h2 id="创建命令"><a href="#创建命令" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/GetUserHouses</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口"><a href="#流程与接口" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543153060818.jpg" alt="mg"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/houses</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;houses&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;西三旗桥东&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;area_name&quot;</span>: <span class="string">&quot;昌平区&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-06 11:16:24&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;house_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;room_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_avatar&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;北清路郑上路&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;area_name&quot;</span>: <span class="string">&quot;顺义区&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-06 11:38:54&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;house_id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBKtmAC8y8AAZcKg5PznU817.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">&quot;room_count&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;修正大厦302教室&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_avatar&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h2><p>根据接口定义，生成对应的proto文件，proto文件内容如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> go.micro.srv.getHouse;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">GetHouse</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Call(Request) <span class="keyword">returns</span> (Response) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    houses data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">houses</span></span>&#123;</span><br><span class="line">    <span class="keyword">repeated</span> houseInfo houses = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">houseInfo</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> address = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> area_name = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> ctime = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">int32</span> house_id = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">string</span> img_url = <span class="number">5</span>;</span><br><span class="line">    <span class="built_in">int32</span> order_count = <span class="number">6</span>;</span><br><span class="line">    <span class="built_in">int32</span> price = <span class="number">7</span>;</span><br><span class="line">    <span class="built_in">int32</span> room_count = <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">string</span> title = <span class="number">9</span>;</span><br><span class="line">    <span class="built_in">string</span> user_avatar = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编译proto文件，接着去main.go文件中，删除不需要的部分，并添加consul服务发现，然后去hander里面处理具体的业务代码，具体代码内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *GetHouse)</span> <span class="title">Call</span><span class="params">(ctx context.Context, req *getHouse.Request, rsp *getHouse.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">//查询数据库,根据用户名获取房源信息</span></span><br><span class="line">    db,err :=model.InitDb()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//具体数据库操作，封装成函数，在下面展示</span></span><br><span class="line">    houses,user,areas,err :=model.GetHouses(db,req.Name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据返回数据，构造返回值</span></span><br><span class="line">    <span class="keyword">var</span> houseInfos getHouse.Houses</span><br><span class="line">    <span class="keyword">for</span> k,v := <span class="keyword">range</span> houses&#123;</span><br><span class="line">        <span class="keyword">var</span> house getHouse.HouseInfo</span><br><span class="line"></span><br><span class="line">        house.Address = v.Address</span><br><span class="line">        house.HouseId = <span class="keyword">int32</span>(v.ID)</span><br><span class="line">        house.Ctime = v.CreatedAt.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>)</span><br><span class="line">        house.ImgUrl = v.Index_image_url</span><br><span class="line">        house.OrderCount = <span class="keyword">int32</span>(v.Order_count)</span><br><span class="line">        house.Price = <span class="keyword">int32</span>(v.Price)</span><br><span class="line">        house.RoomCount = <span class="keyword">int32</span>(v.Room_count)</span><br><span class="line">        house.Title = v.Title</span><br><span class="line">        house.UserAvatar = user.Avatar_url</span><br><span class="line">        house.AreaName = areas[k].Name</span><br><span class="line"></span><br><span class="line">        houseInfos.Houses = <span class="built_in">append</span>(houseInfos.Houses,&amp;house)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;houseInfos = &quot;</span>,houseInfos,<span class="string">&quot;areas = &quot;</span>,areas)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    rsp.Errno = utils.RECODE_OK</span><br><span class="line">    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">    rsp.Data = &amp;houseInfos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们把数据库操作封装到函数里面，函数实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据用户名获取当前用户的房源信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHouses</span><span class="params">(db *gorm.DB, name <span class="keyword">string</span>)</span> <span class="params">([]House, User, []Area, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//查询当前用户对象</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    err := db.Where(<span class="string">&quot;name = ?&quot;</span>, name).First(&amp;user).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, User&#123;&#125;, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询当前用户对应的房屋</span></span><br><span class="line">    <span class="keyword">var</span> houses []House</span><br><span class="line">    err = db.Model(&amp;user).Related(&amp;houses).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, User&#123;&#125;, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取各个房源对应的地址</span></span><br><span class="line">    <span class="keyword">var</span> areas []Area</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> houses &#123;</span><br><span class="line">        <span class="keyword">var</span> area Area</span><br><span class="line">        err = db.Model(&amp;v).Related(&amp;area).Error</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, User&#123;&#125;, <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        areas = <span class="built_in">append</span>(areas, area)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> houses, user, areas, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web端实现"><a href="#web端实现" class="headerlink" title="web端实现"></a>web端实现</h2><p>根据设计文档，这里我们给对应请求添加路由，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.GET(<span class="string">&quot;/user/houses&quot;</span>,controller.GetUserHouses)</span><br></pre></td></tr></table></figure>

<p>然后到controller中实现对应请求方法，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前用户发布房源信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserHouses</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取用户名</span></span><br><span class="line">    s := sessions.Default(ctx)</span><br><span class="line">    userName := s.Get(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用远程服务</span></span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := getHouse.NewGetHouseService(utils.GetHouseName,grpcService.Client())</span><br><span class="line">    resp,err := client.Call(context.TODO(),&amp;getHouse.Request&#123;Name:userName.(<span class="keyword">string</span>)&#125;)</span><br><span class="line">    fmt.Println(<span class="string">&quot;resp = &quot;</span>,err)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        resp.Errno = utils.RECODE_SERVERERR</span><br><span class="line">        resp.Errmsg = utils.RecodeText(utils.RECODE_SERVERERR)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-发布房源信息"><a href="#10-发布房源信息" class="headerlink" title="10 发布房源信息"></a>10 发布房源信息</h1><p>发送（发布）房源信息服务（商品相关）</p>
<h2 id="创建命令-1"><a href="#创建命令-1" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/PostHouses</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-1"><a href="#流程与接口-1" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543153360870.jpg" alt="mg"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">url:api/v1<span class="number">.0</span>/houses</span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;title&quot;</span>:<span class="string">&quot;上奥世纪中心&quot;</span>,</span><br><span class="line"><span class="attr">&quot;price&quot;</span>:<span class="string">&quot;666&quot;</span>,</span><br><span class="line"><span class="attr">&quot;area_id&quot;</span>:<span class="string">&quot;5&quot;</span>,</span><br><span class="line"><span class="attr">&quot;address&quot;</span>:<span class="string">&quot;西三旗桥东建材城1号&quot;</span>,</span><br><span class="line"><span class="attr">&quot;room_count&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line"><span class="attr">&quot;acreage&quot;</span>:<span class="string">&quot;60&quot;</span>,</span><br><span class="line"><span class="attr">&quot;unit&quot;</span>:<span class="string">&quot;2室1厅&quot;</span>,</span><br><span class="line"><span class="attr">&quot;capacity&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line"><span class="attr">&quot;beds&quot;</span>:<span class="string">&quot;双人床2张&quot;</span>,</span><br><span class="line"><span class="attr">&quot;deposit&quot;</span>:<span class="string">&quot;200&quot;</span>,</span><br><span class="line"><span class="attr">&quot;min_days&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line"><span class="attr">&quot;max_days&quot;</span>:<span class="string">&quot;0&quot;</span>,</span><br><span class="line"><span class="attr">&quot;facility&quot;</span>:[<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>,<span class="string">&quot;7&quot;</span>,<span class="string">&quot;12&quot;</span>,<span class="string">&quot;14&quot;</span>,<span class="string">&quot;16&quot;</span>,<span class="string">&quot;17&quot;</span>,<span class="string">&quot;18&quot;</span>,<span class="string">&quot;21&quot;</span>,<span class="string">&quot;22&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span></span><br><span class="line">  <span class="string">&quot;data&quot;</span> :&#123;</span><br><span class="line">        <span class="attr">&quot;house_id&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务端实现-1"><a href="#服务端实现-1" class="headerlink" title="服务端实现"></a>服务端实现</h2><p>创建服务，然后根据接口定义我们来修改服务的proto文件，proto内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> <span class="keyword">go</span>.micro.srv.postHouse;</span><br><span class="line"></span><br><span class="line">service PostHouse &#123;</span><br><span class="line">    rpc Call(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    <span class="keyword">string</span> acreage = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> address = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">string</span> area_id = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">string</span> beds = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">string</span> capacity = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">string</span> deposit = <span class="number">6</span>;</span><br><span class="line">    repeated <span class="keyword">string</span> facility = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">string</span> min_days = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">string</span> max_days = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">string</span> price = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">string</span> room_count = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">string</span> title = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">string</span> unit = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">string</span> name = <span class="number">14</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    <span class="keyword">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">int32</span>&gt; data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改main.go文件，然后到handler中实现具体服务内容，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发布房源,插入操作</span></span><br><span class="line">db,err := model.InitDb()</span><br><span class="line"><span class="comment">//向数据库中插入数据</span></span><br><span class="line"><span class="keyword">var</span> house model.House</span><br><span class="line">acrea,_ :=strconv.Atoi(req.Acreage)</span><br><span class="line">house.Acreage = acrea</span><br><span class="line">house.Address = req.Address</span><br><span class="line">areaId ,_ :=strconv.Atoi(req.AreaId)</span><br><span class="line">house.AreaId = <span class="keyword">uint</span>(areaId)</span><br><span class="line">house.Beds = req.Beds</span><br><span class="line"><span class="built_in">cap</span>,_ :=strconv.Atoi(req.Capacity)</span><br><span class="line">house.Capacity = <span class="built_in">cap</span></span><br><span class="line">dep ,_ :=strconv.Atoi(req.Deposit)</span><br><span class="line">house.Deposit = dep</span><br><span class="line">maxDays ,_ :=strconv.Atoi(req.MaxDays)</span><br><span class="line">house.Max_days = maxDays</span><br><span class="line">minDays,_ :=strconv.Atoi(req.MinDays)</span><br><span class="line">house.Min_days = minDays</span><br><span class="line">price ,_:= strconv.Atoi(req.Price)</span><br><span class="line">house.Price = price</span><br><span class="line">house.Title = req.Title</span><br><span class="line">house.Unit = req.Unit</span><br><span class="line"></span><br><span class="line">roomCount,_ :=strconv.Atoi(req.RoomCount)</span><br><span class="line">house.Room_count = roomCount</span><br><span class="line"><span class="comment">//在model中封装插入函数，具体实现请往下看</span></span><br><span class="line">houseId,err := model.InserHouse(db,req.Name,house,req.Facility)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置返回值</span></span><br><span class="line">rsp.Errno = utils.RECODE_OK</span><br><span class="line">rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">rsp.Data = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int32</span>&#123;<span class="string">&quot;house_id&quot;</span>:<span class="keyword">int32</span>(houseId)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>model中插入房源函数实现，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发布房源</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InserHouse</span><span class="params">(db*gorm.DB,name <span class="keyword">string</span>,house House,fids []<span class="keyword">string</span>)</span><span class="params">(<span class="keyword">uint</span>,error)</span></span>&#123;</span><br><span class="line">    <span class="comment">//根据用户名获取用户Id</span></span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    user.Name = name</span><br><span class="line">    err := db.Where(<span class="string">&quot;name = ?&quot;</span>,name).Find(&amp;user).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关联当前用户</span></span><br><span class="line">    house.UserId = <span class="keyword">uint</span>(user.ID)</span><br><span class="line">    <span class="comment">//查询所有家具放到house里面</span></span><br><span class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> fids&#123;</span><br><span class="line">        id ,_:=strconv.Atoi(v)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> fac Facility</span><br><span class="line">        err := db.Where(<span class="string">&quot;id = ?&quot;</span>,id).Find(&amp;fac).Error</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>,err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        house.Facilities = <span class="built_in">append</span>(house.Facilities,&amp;fac)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> house.ID, db.Create(&amp;house).Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web端实现-1"><a href="#web端实现-1" class="headerlink" title="web端实现"></a>web端实现</h2><p>根据接口文档定义，给对应请求添加路由对应，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.POST(<span class="string">&quot;/houses&quot;</span>,controller.PostHouses)</span><br></pre></td></tr></table></figure>

<p>然后到controller中实现具体操作，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HouseInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">    Title <span class="keyword">string</span> <span class="string">`json:&quot;title&quot;`</span></span><br><span class="line">    Acreage <span class="keyword">string</span> <span class="string">`json:&quot;acreage&quot;`</span></span><br><span class="line">    Address <span class="keyword">string</span>     <span class="string">`json:&quot;address&quot;`</span></span><br><span class="line">    AreaId <span class="keyword">string</span>  <span class="string">`json:&quot;area_id&quot;`</span></span><br><span class="line">    Beds <span class="keyword">string</span>    <span class="string">`json:&quot;beds&quot;`</span></span><br><span class="line">    Capacity <span class="keyword">string</span> <span class="string">`json:&quot;capacity&quot;`</span></span><br><span class="line">    Deposit <span class="keyword">string</span> <span class="string">`json:&quot;deposit&quot;`</span></span><br><span class="line">    Facility []<span class="keyword">string</span> <span class="string">`json:&quot;facility&quot;`</span></span><br><span class="line">    MaxDays <span class="keyword">string</span> <span class="string">`json:&quot;max_days&quot;`</span></span><br><span class="line">    MinDays <span class="keyword">string</span> <span class="string">`json:&quot;min_days&quot;`</span></span><br><span class="line">    Price <span class="keyword">string</span>   <span class="string">`json:&quot;price&quot;`</span></span><br><span class="line">    RoomCount <span class="keyword">string</span> <span class="string">`json:&quot;room_count&quot;`</span></span><br><span class="line">    Unit <span class="keyword">string</span>    <span class="string">`json:&quot;unit&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发布房源</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostHouses</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line">    <span class="comment">//定义错误容器</span></span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取前端传递过来的数据</span></span><br><span class="line">    <span class="keyword">var</span> houseInfo HouseInfo</span><br><span class="line">    err := ctx.Bind(&amp;houseInfo)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_REQERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_REQERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;houseInfo = &quot;</span>,houseInfo)</span><br><span class="line">    <span class="comment">//获取当前用户名</span></span><br><span class="line">    s := sessions.Default(ctx)</span><br><span class="line">    userName := s.Get(<span class="string">&quot;userName&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程服务调用</span></span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := postHouse.NewPostHouseService(utils.PostHouseName,grpcService.Client())</span><br><span class="line">    resp ,err:=client.Call(context.TODO(),&amp;postHouse.Request&#123;</span><br><span class="line">        Name:userName.(<span class="keyword">string</span>),</span><br><span class="line">        Acreage:houseInfo.Acreage,</span><br><span class="line">        Address:houseInfo.Address,</span><br><span class="line">        AreaId:houseInfo.AreaId,</span><br><span class="line">        Beds:houseInfo.Beds,</span><br><span class="line">        Capacity:houseInfo.Capacity,</span><br><span class="line">        Deposit:houseInfo.Deposit,</span><br><span class="line">        Facility:houseInfo.Facility,</span><br><span class="line">        MaxDays:houseInfo.MaxDays,</span><br><span class="line">        MinDays:houseInfo.MinDays,</span><br><span class="line">        Price:houseInfo.Price,</span><br><span class="line">        RoomCount:houseInfo.RoomCount,</span><br><span class="line">        Title:houseInfo.Title,</span><br><span class="line">        Unit:houseInfo.Unit,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SERVERERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SERVERERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="11-上传房屋图片"><a href="#11-上传房屋图片" class="headerlink" title="11 上传房屋图片"></a>11 上传房屋图片</h1><p>发送（上传）房屋图片服务（商品相关）</p>
<h2 id="创建命令-2"><a href="#创建命令-2" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/PostHousesImage</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-2"><a href="#流程与接口-2" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543153464298.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">#<span class="number">3</span>表示房源id</span><br><span class="line">url:api/v1<span class="number">.0</span>/houses/<span class="number">3</span>/images </span><br><span class="line">url:api/v1<span class="number">.0</span>/houses/:id/images </span><br><span class="line"></span><br><span class="line">#data:</span><br><span class="line">图片二进制数据</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLmWAHlsrAAaInSze-cQ719.jpg&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务端实现-2"><a href="#服务端实现-2" class="headerlink" title="服务端实现"></a>服务端实现</h2><p>创建服务，根据接口定义，修改proto文件，proto文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> <span class="keyword">go</span>.micro.srv.uploadHouseImage;</span><br><span class="line"></span><br><span class="line">service UploadHouseImage &#123;</span><br><span class="line">    rpc Call(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    <span class="keyword">int32</span> house_id = <span class="number">1</span>;</span><br><span class="line">    bytes houseBuffer = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">string</span> fileExt = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    <span class="keyword">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt;data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改main.go文件，添加consul服务发现，然后实现hander中具体的业务，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取fastDFS操作对象</span></span><br><span class="line">fdfsClient,err:= fdfs_client.NewFdfsClient(<span class="string">&quot;/etc/fdfs/client.conf&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通过字节切片上传文件到fastDFS</span></span><br><span class="line">fdfsResp,err := fdfsClient.UploadByBuffer(req.HouseBuffer,req.FileExt)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把数据存储到数据库,这里把数据库操作封装成函数，具体代码往下看</span></span><br><span class="line">db,err := model.InitDb()</span><br><span class="line">err = model.UploadHouseImage(db,<span class="keyword">uint</span>(req.HouseId),utils.NginxPath+fdfsResp.RemoteFileId)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回数据</span></span><br><span class="line">rsp.Errno = utils.RECODE_OK</span><br><span class="line">rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">rsp.Data = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;url&quot;</span>:utils.NginxPath+fdfsResp.RemoteFileId&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>models中上传房屋图片的操作代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上传房屋图片</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UploadHouseImage</span><span class="params">(db*gorm.DB,houseId <span class="keyword">uint</span>,imgUrl <span class="keyword">string</span>)</span><span class="title">error</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> house House</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询对应 房屋信息</span></span><br><span class="line">    err := db.First(&amp;house,houseId).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> house.Index_image_url == <span class="string">&quot;&quot;</span>&#123;</span><br><span class="line">        err = db.Model(&amp;house).Update(<span class="string">&quot;index_image_url&quot;</span>,imgUrl).Error</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> houseImage HouseImage</span><br><span class="line">        houseImage.HouseId = houseId</span><br><span class="line">        <span class="keyword">return</span> db.Create(&amp;houseImage).Error</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web端实现-2"><a href="#web端实现-2" class="headerlink" title="web端实现"></a>web端实现</h2><p>根据接口文档，给请求添加对应路由，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.POST(<span class="string">&quot;/houses/:id/images&quot;</span>,controller.PostHousesImage)</span><br></pre></td></tr></table></figure>

<p>接着到controller中实现具体代码，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostHousesImage</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    houseId := ctx.Param(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    <span class="comment">//这里我们发现，已经操作上传文件两次了，可以把上传文件操作封装成函数，代码在下面</span></span><br><span class="line">    fileBuffer,fileExt := UploadFile(ctx,errResp,<span class="string">&quot;house_image&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> fileBuffer == <span class="literal">nil</span> &#123;</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用远程服务</span></span><br><span class="line">    id,_ := strconv.Atoi(houseId)</span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := uploadHouseImage.NewUploadHouseImageService(utils.UploadHouseImage,grpcService.Client())</span><br><span class="line">    resp,err := client.Call(context.TODO(),&amp;uploadHouseImage.Request&#123;</span><br><span class="line">        HouseId:<span class="keyword">int32</span>(id),</span><br><span class="line">        FileExt:fileExt,</span><br><span class="line">        HouseBuffer:fileBuffer,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SERVERERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SERVERERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上传文件的函数封装，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UploadFile</span><span class="params">(ctx*gin.Context,errResp <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>,fileName <span class="keyword">string</span>)</span><span class="params">([]<span class="keyword">byte</span>,<span class="keyword">string</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    fileHeader,err := ctx.FormFile(fileName)</span><br><span class="line">    <span class="comment">//校验数据</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_DATAERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_DATAERR)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,<span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//大小校验</span></span><br><span class="line">    <span class="keyword">if</span> fileHeader.Size &gt; <span class="number">500000</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_MOREBIG</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_MOREBIG)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,<span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//格式校验</span></span><br><span class="line">    fileExt := path.Ext(fileHeader.Filename)</span><br><span class="line">    <span class="keyword">if</span> fileExt != <span class="string">&quot;.jpg&quot;</span> &amp;&amp; fileExt != <span class="string">&quot;.png&quot;</span> &amp;&amp; fileExt != <span class="string">&quot;.jepg&quot;</span>&#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_FORMATERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_FORMATERR)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,<span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file,_ := fileHeader.Open()</span><br><span class="line">    buffer := <span class="built_in">make</span>([]<span class="keyword">byte</span>,fileHeader.Size)</span><br><span class="line">    file.Read(buffer)</span><br><span class="line">    <span class="keyword">return</span> buffer,fileExt[<span class="number">1</span>:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="12-获取房源详细信息"><a href="#12-获取房源详细信息" class="headerlink" title="12 获取房源详细信息"></a>12 获取房源详细信息</h1><p>获取房屋详细信息服务（商品相关）</p>
<h2 id="创建命令-3"><a href="#创建命令-3" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/GetHouseInfo</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-3"><a href="#流程与接口-3" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543153705596.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">#<span class="number">1</span>表示房源id</span><br><span class="line">url:api/v1<span class="number">.0</span>/houses/<span class="number">1</span></span><br><span class="line">url:api/v1<span class="number">.0</span>/houses/:id</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;house&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;acreage&quot;</span>: <span class="number">80</span>,</span><br><span class="line">      <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;西三旗桥东&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;beds&quot;</span>: <span class="string">&quot;2双人床&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;capacity&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;comments&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;评论的内容&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-12 12:30:30&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;评论人的姓名&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;评论的内容&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-12 12:30:30&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;评论人的姓名&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;评论的内容&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-12 12:30:30&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;评论人的姓名&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;deposit&quot;</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="attr">&quot;facilities&quot;</span>: [<span class="number">9</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>,<span class="number">23</span>],</span><br><span class="line">      <span class="attr">&quot;hid&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;img_urls&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJZmAYqGWAAaInSze-cQ230.jpg&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;max_days&quot;</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">&quot;min_days&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">&quot;room_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;unit&quot;</span>: <span class="string">&quot;3室3厅&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;user_avatar&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;user_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;user_name&quot;</span>: <span class="string">&quot;Panda&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务端实现-3"><a href="#服务端实现-3" class="headerlink" title="服务端实现"></a>服务端实现</h2><p>创建服务，然后根据接口定义，修改proto文件，proto文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> <span class="keyword">go</span>.micro.srv.getHouseDetail;</span><br><span class="line"></span><br><span class="line">service GetHouseDetail &#123;</span><br><span class="line">    rpc Call(Request) returns (Response) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    <span class="keyword">int32</span> houseId = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    <span class="keyword">string</span> errno = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> errmsg = <span class="number">2</span>;</span><br><span class="line">    data data = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message data&#123;</span><br><span class="line">    houseInfo house = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int32</span> user_id = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message houseInfo &#123;</span><br><span class="line">    <span class="keyword">int32</span> acreage = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> address = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">string</span> beds = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int32</span> capacity = <span class="number">4</span>;</span><br><span class="line">    repeated commentInfo comments = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int32</span> deposit = <span class="number">6</span>;</span><br><span class="line">    repeated <span class="keyword">int32</span> facilities = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">int32</span> hid = <span class="number">8</span>;</span><br><span class="line">    repeated <span class="keyword">string</span> img_urls = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">int32</span> max_days = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int32</span> min_days = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">int32</span> price = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">int32</span> room_count = <span class="number">13</span>;</span><br><span class="line">    <span class="keyword">string</span> title = <span class="number">14</span>;</span><br><span class="line">    <span class="keyword">string</span> unit = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">string</span> user_avatar = <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">int32</span> user_id = <span class="number">17</span>;</span><br><span class="line">    <span class="keyword">string</span> user_name = <span class="number">18</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message commentInfo&#123;</span><br><span class="line">    <span class="keyword">string</span> comment = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">string</span> ctime = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">string</span> user_name = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改main.go文件，然后去hander中实现具体业务，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从redis数据库中获取数据</span></span><br><span class="line"><span class="keyword">var</span> data getHouseDetail.Data</span><br><span class="line">redisConn := model.InitRedis().Get()</span><br><span class="line">houseBuffer, _ := redis.Bytes(redisConn.Do(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;houseId_&quot;</span>+strconv.Itoa(<span class="keyword">int</span>(req.HouseId))))</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(houseBuffer) == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="comment">//如果查不到数据,就从数据库获取</span></span><br><span class="line">    <span class="comment">// 获取数据库实例</span></span><br><span class="line">    db, err := model.InitDb()</span><br><span class="line">    <span class="comment">//把具体的操作封装成函数</span></span><br><span class="line">    house, orders, orderUsers, user, facs, imgs, err := model.GetDetail(db, req.HouseId)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取评论数据</span></span><br><span class="line">    <span class="keyword">var</span> comments []*getHouseDetail.CommentInfo</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> orders &#123;</span><br><span class="line">        <span class="keyword">var</span> commment getHouseDetail.CommentInfo</span><br><span class="line">        commment.Ctime = v.UpdatedAt.Format(<span class="string">&quot;2006:01:02 15:04:05&quot;</span>)</span><br><span class="line">        commment.UserName = orderUsers[k].Name</span><br><span class="line">        commment.Comment = v.Comment</span><br><span class="line"></span><br><span class="line">        comments = <span class="built_in">append</span>(comments, &amp;commment)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取家具数据</span></span><br><span class="line">    <span class="keyword">var</span> fids []<span class="keyword">int32</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> facs &#123;</span><br><span class="line">        fids = <span class="built_in">append</span>(fids, <span class="keyword">int32</span>(v.ID))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取图片</span></span><br><span class="line">    <span class="keyword">var</span> imgPaths []<span class="keyword">string</span></span><br><span class="line">    imgPaths = <span class="built_in">append</span>(imgPaths, house.Index_image_url)</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> imgs &#123;</span><br><span class="line">        imgPaths = <span class="built_in">append</span>(imgPaths, v.Url)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置返回数据</span></span><br><span class="line">    <span class="keyword">var</span> houseInfo getHouseDetail.HouseInfo</span><br><span class="line">    houseInfo.Acreage = <span class="keyword">int32</span>(house.Acreage)</span><br><span class="line">    houseInfo.Address = house.Address</span><br><span class="line">    houseInfo.Beds = house.Beds</span><br><span class="line">    houseInfo.Capacity = <span class="keyword">int32</span>(house.Capacity)</span><br><span class="line">    houseInfo.Comments = comments</span><br><span class="line">    houseInfo.Deposit = <span class="keyword">int32</span>(house.Deposit)</span><br><span class="line">    houseInfo.Facilities = fids</span><br><span class="line">    houseInfo.Hid = <span class="keyword">int32</span>(house.ID)</span><br><span class="line">    houseInfo.ImgUrls = imgPaths</span><br><span class="line">    houseInfo.MinDays = <span class="keyword">int32</span>(house.Min_days)</span><br><span class="line">    houseInfo.MaxDays = <span class="keyword">int32</span>(house.Max_days)</span><br><span class="line">    houseInfo.Price = <span class="keyword">int32</span>(house.Price)</span><br><span class="line">    houseInfo.RoomCount = <span class="keyword">int32</span>(house.Room_count)</span><br><span class="line">    houseInfo.Title = house.Title</span><br><span class="line">    houseInfo.Unit = house.Unit</span><br><span class="line">    houseInfo.UserAvatar = user.Avatar_url</span><br><span class="line">    houseInfo.UserId = <span class="keyword">int32</span>(house.UserId)</span><br><span class="line">    houseInfo.UserName = user.Name</span><br><span class="line"></span><br><span class="line">    data.House = &amp;houseInfo</span><br><span class="line">    data.UserId = <span class="keyword">int32</span>(user.ID)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把查询到的数据存储到redis中</span></span><br><span class="line">    buffer,err := json.Marshal(data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    redisConn.Do(<span class="string">&quot;set&quot;</span>,<span class="string">&quot;houseId_&quot;</span>+strconv.Itoa(<span class="keyword">int</span>(house.ID)),buffer)</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果查到数据,就直接解析数据</span></span><br><span class="line">    err := json.Unmarshal(houseBuffer,data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回数据</span></span><br><span class="line">rsp.Errno = utils.RECODE_OK</span><br><span class="line">rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)</span><br><span class="line">rsp.Data = &amp;data</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>model中封装的函数具体内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据房屋id获取房屋信息,获取评论,用户信息,家具信息,房屋图片</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDetail</span><span class="params">(db*gorm.DB,houseId <span class="keyword">int32</span>)</span><span class="params">(House,[]OrderHouse,[]User,User,[]Facility,[]HouseImage,error)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> house House</span><br><span class="line">    <span class="keyword">var</span> orders []OrderHouse</span><br><span class="line">    <span class="keyword">var</span> orderUsers []User</span><br><span class="line">    <span class="keyword">var</span> user User</span><br><span class="line">    <span class="keyword">var</span> facs []Facility</span><br><span class="line">    <span class="keyword">var</span> imgs []HouseImage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    house.ID = <span class="keyword">uint</span>(houseId)</span><br><span class="line">    err := db.Where(&amp;house).First(&amp;house).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取评论信息</span></span><br><span class="line">    err = db.Model(&amp;house).Related(&amp;orders).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取评论用户信息</span></span><br><span class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> orders&#123;</span><br><span class="line">        <span class="keyword">var</span> orderUser User</span><br><span class="line">        err := db.Model(&amp;v).Related(&amp;orderUser).Error</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">        &#125;</span><br><span class="line">        orderUsers = <span class="built_in">append</span>(orderUsers,orderUser)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取用户信息</span></span><br><span class="line">    err = db.Model(&amp;house).Related(&amp;user).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取家具信息</span></span><br><span class="line">    err = db.Model(&amp;house).Related(&amp;facs,<span class="string">&quot;Facilities&quot;</span>).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取房屋图片</span></span><br><span class="line">    err = db.Model(&amp;house).Related(&amp;imgs).Error</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> house,orders,orderUsers,user,facs,imgs,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web端实现-3"><a href="#web端实现-3" class="headerlink" title="web端实现"></a>web端实现</h2><p>根据接口定义，给请求设置对应路由，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r1.GET(<span class="string">&quot;/houses/:id&quot;</span>,controller.GetHouseInfo)</span><br></pre></td></tr></table></figure>

<p>然后去controller中实现对应业务，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取房屋详细信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetHouseInfo</span><span class="params">(ctx*gin.Context)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    errResp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    houseId := ctx.Param(<span class="string">&quot;id&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验数据</span></span><br><span class="line">    id,err := strconv.Atoi(houseId)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_REQERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_REQERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用远程服务</span></span><br><span class="line">    grpcService := utils.GetGrpcService()</span><br><span class="line">    client := getDetail.NewGetHouseDetailService(utils.GetDetail,grpcService.Client())</span><br><span class="line">    resp,err := client.Call(context.TODO(),&amp;getDetail.Request&#123;HouseId:<span class="keyword">int32</span>(id)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        errResp[<span class="string">&quot;errno&quot;</span>] = utils.RECODE_SERVERERR</span><br><span class="line">        errResp[<span class="string">&quot;errmsg&quot;</span>] = utils.RecodeText(utils.RECODE_SERVERERR)</span><br><span class="line">        ctx.JSON(<span class="number">200</span>,errResp)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.JSON(<span class="number">200</span>,resp)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="13-获取首页动画图片"><a href="#13-获取首页动画图片" class="headerlink" title="13 获取首页动画图片"></a>13 获取首页动画图片</h1><p>获取首页轮播图片服务（首页相关）</p>
<h2 id="创建命令-4"><a href="#创建命令-4" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/GetIndex</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-4"><a href="#流程与接口-4" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543154107047.jpg" alt="im"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Request:</span></span><br><span class="line">method: GET</span><br><span class="line">url:api/v1.0/house/index</span><br><span class="line"><span class="meta">#</span><span class="bash">data:</span></span><br><span class="line">no input data</span><br><span class="line"><span class="meta">#</span><span class="bash">Response</span></span><br><span class="line"><span class="meta">#</span><span class="bash">返回成功：</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;errno&quot;: &quot;0&quot;,</span><br><span class="line">  &quot;errmsg&quot;: &quot;成功&quot;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">        &quot;houses&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;house_id&quot;:    this.Id,</span><br><span class="line">        &quot;title&quot;:       this.Title,</span><br><span class="line">        &quot;price&quot;:       this.Price,</span><br><span class="line">        &quot;area_name&quot;:   this.Area.Name,</span><br><span class="line">        &quot;img_url&quot;:     utils.AddDomain2Url(this.Index_image_url),</span><br><span class="line">        &quot;room_count&quot;:  this.Room_count,</span><br><span class="line">        &quot;order_count&quot;: this.Order_count,</span><br><span class="line">        &quot;address&quot;:     this.Address,</span><br><span class="line">        &quot;user_avatar&quot;: utils.AddDomain2Url(this.User.Avatar_url),</span><br><span class="line">        &quot;ctime&quot;:       this.Ctime.Format(&quot;2006-01-02 15:04:05&quot;),</span><br><span class="line">    &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;house_id&quot;:    this.Id,</span><br><span class="line">        &quot;title&quot;:       this.Title,</span><br><span class="line">        &quot;price&quot;:       this.Price,</span><br><span class="line">        &quot;area_name&quot;:   this.Area.Name,</span><br><span class="line">        &quot;img_url&quot;:     utils.AddDomain2Url(this.Index_image_url),</span><br><span class="line">        &quot;room_count&quot;:  this.Room_count,</span><br><span class="line">        &quot;order_count&quot;: this.Order_count,</span><br><span class="line">        &quot;address&quot;:     this.Address,</span><br><span class="line">        &quot;user_avatar&quot;: utils.AddDomain2Url(this.User.Avatar_url),</span><br><span class="line">        &quot;ctime&quot;:       this.Ctime.Format(&quot;2006-01-02 15:04:05&quot;),</span><br><span class="line">    &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">返回失败：</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;errno&quot;: &quot;400x&quot;,   //状态码</span><br><span class="line">    &quot;errmsg&quot;:&quot;状态错误信息&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="14-搜索房源"><a href="#14-搜索房源" class="headerlink" title="14 搜索房源"></a>14 搜索房源</h1><p>获取（搜索）房源服务（商品相关）</p>
<h2 id="创建命令-5"><a href="#创建命令-5" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/GetHouses</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-5"><a href="#流程与接口-5" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543154391621.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">#adi表示地区编号</span><br><span class="line">#sd表示起始日期</span><br><span class="line">#ed表示结束日期</span><br><span class="line">#sk表示查询方式</span><br><span class="line">#p表示页码</span><br><span class="line">url:api/v1<span class="number">.0</span>/houses?aid=<span class="number">5</span>&amp;sd=<span class="number">2017</span><span class="number">-11</span><span class="number">-12</span>&amp;ed=<span class="number">2017</span><span class="number">-11</span><span class="number">-30</span>&amp;sk=new</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;current_page&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;houses&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;西三旗桥东&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;area_name&quot;</span>: <span class="string">&quot;昌平区&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-06 11:16:24&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;house_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;room_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心13号楼&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_avatar&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;西三旗桥东&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;area_name&quot;</span>: <span class="string">&quot;昌平区&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-06 11:16:24&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;house_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;room_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心18号楼&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_avatar&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;total_page&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="15-发布订单"><a href="#15-发布订单" class="headerlink" title="15 发布订单"></a>15 发布订单</h1><p>发送（发布）订单服务（订单相关）</p>
<h2 id="创建命令-6"><a href="#创建命令-6" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/PostOrders</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-6"><a href="#流程与接口-6" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543154867892.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: POST</span><br><span class="line">url:api/v1<span class="number">.0</span>/orders</span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;house_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start_date&quot;</span>: <span class="string">&quot;2017-11-11 21:23:49&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;end_date&quot;</span>: <span class="string">&quot;2017-11-12 21:23:49&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;order_id&quot;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="16-请求查看房东-租客订单信息"><a href="#16-请求查看房东-租客订单信息" class="headerlink" title="16 请求查看房东/租客订单信息"></a>16 请求查看房东/租客订单信息</h1><p>获取房东/租户订单信息服务（订单相关）</p>
<h2 id="创建命令-7"><a href="#创建命令-7" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/GetUserOrder</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-7"><a href="#流程与接口-7" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543155051108.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: GET</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/orders?role=custom 备注:role=custom为租客查看订单信息</span><br><span class="line">url:api/v1<span class="number">.0</span>/user/orders?role=landlord 备注:role=landlord为房东查看被预定订单信息</span><br><span class="line">#data:</span><br><span class="line">no input data</span><br><span class="line"></span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;orders&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;amount&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;哈哈拒接&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-11 21:23:49&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;days&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;end_date&quot;</span>: <span class="string">&quot;2017-11-29 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;start_date&quot;</span>: <span class="string">&quot;2017-11-28 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;REJECTED&quot;</span>,<span class="comment">//WAIT_ACCPET,WAIT_COMMENT,REJECTED,COMPLETE,CANCELED</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;amount&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">        <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-11 01:32:10&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;days&quot;</span>: <span class="number">15</span>,</span><br><span class="line">        <span class="attr">&quot;end_date&quot;</span>: <span class="string">&quot;2017-11-24 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;start_date&quot;</span>: <span class="string">&quot;2017-11-10 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;WAIT_COMMENT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;amount&quot;</span>: <span class="number">300</span>,</span><br><span class="line">        <span class="attr">&quot;comment&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2017-11-10 01:46:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;days&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;end_date&quot;</span>: <span class="string">&quot;2017-11-11 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;img_url&quot;</span>: <span class="string">&quot;http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;order_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;start_date&quot;</span>: <span class="string">&quot;2017-11-09 16:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;WAIT_COMMENT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;上奥世纪中心&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="17-房东同意-拒绝订单"><a href="#17-房东同意-拒绝订单" class="headerlink" title="17 房东同意/拒绝订单"></a>17 房东同意/拒绝订单</h1><p>更新房东同意/拒绝订单（订单相关）</p>
<h2 id="创建命令-8"><a href="#创建命令-8" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/PutOrders</span></span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-8"><a href="#流程与接口-8" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543155208535.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: PUT</span><br><span class="line">#<span class="number">4</span>表示订单id</span><br><span class="line">url:api/v1<span class="number">.0</span>/orders/<span class="number">4</span>/status</span><br><span class="line">url:api/v1<span class="number">.0</span>/orders/:id/status</span><br><span class="line">#data:</span><br><span class="line">#<span class="string">&quot;accept&quot;</span>表示接受</span><br><span class="line">#<span class="string">&quot;reject&quot;</span>表示拒绝</span><br><span class="line">&#123;action: <span class="string">&quot;accept&quot;</span>&#125;   </span><br><span class="line"></span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="18-用户评价订单信息"><a href="#18-用户评价订单信息" class="headerlink" title="18 用户评价订单信息"></a>18 用户评价订单信息</h1><p>更新用户评价订单信息（订单相关）</p>
<h2 id="创建命令-9"><a href="#创建命令-9" class="headerlink" title="创建命令"></a>创建命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> micro new --<span class="built_in">type</span> <span class="string">&quot;srv&quot;</span> sss/PutComment</span> </span><br></pre></td></tr></table></figure>

<h2 id="流程与接口-9"><a href="#流程与接口-9" class="headerlink" title="流程与接口"></a>流程与接口</h2><p><img src="assets%5Cclip_image002-1543156498014.jpg" alt="im"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#Request:</span><br><span class="line">method: PUT</span><br><span class="line">#<span class="number">2</span>表示订单id0</span><br><span class="line">url:api/v1<span class="number">.0</span>/orders/<span class="number">2</span>/comment </span><br><span class="line">url:api/v1<span class="number">.0</span>/orders/:id/comment </span><br><span class="line">#data:</span><br><span class="line">&#123;</span><br><span class="line">    order_id: <span class="string">&quot;2&quot;</span>, </span><br><span class="line">    comment: <span class="string">&quot;烂房子！&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">#Response</span><br><span class="line">#返回成功：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;errmsg&quot;</span>: <span class="string">&quot;成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#返回失败：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errno&quot;</span>: <span class="string">&quot;400x&quot;</span>,   <span class="comment">//状态码</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;状态错误信息&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"># 微服务</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E8%AE%B2%E4%B9%891/" rel="next" title="微服务相关知识1">
                <i class="fa fa-chevron-left"></i> 微服务相关知识1
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/03/golang/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E8%AE%B2%E4%B9%89/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E8%AE%B2%E4%B9%892/" rel="prev" title="微服务相关知识2">
                微服务相关知识2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/i.jpeg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangzengming" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wangzengming@aliyun.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-session%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.</span> <span class="nav-text">1.session功能实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.1.</span> <span class="nav-text">1.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">1.2.</span> <span class="nav-text">1.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.</span> <span class="nav-text">1.3具体业务实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%B1%95%E7%A4%BA"><span class="nav-number">2.</span> <span class="nav-text">2.用户信息展示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">2.1.</span> <span class="nav-text">2.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">2.2.</span> <span class="nav-text">2.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.</span> <span class="nav-text">2.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.4.</span> <span class="nav-text">2.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E9%80%80%E5%87%BA%E7%99%BB%E9%99%86"><span class="nav-number">3.</span> <span class="nav-text">3.退出登陆</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">3.1.</span> <span class="nav-text">3.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">3.2.</span> <span class="nav-text">3.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.3.</span> <span class="nav-text">3.3业务实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E7%99%BB%E9%99%86%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">4.登陆业务实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">4.1.</span> <span class="nav-text">4.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">4.2.</span> <span class="nav-text">4.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.3.</span> <span class="nav-text">4.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.4.</span> <span class="nav-text">4.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E4%B8%8A%E4%BC%A0%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E4%B8%9A%E5%8A%A1"><span class="nav-number">5.</span> <span class="nav-text">5.上传用户头像业务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">5.1.</span> <span class="nav-text">5.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">5.2.</span> <span class="nav-text">5.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.3.</span> <span class="nav-text">5.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.4.</span> <span class="nav-text">5.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%90%8D"><span class="nav-number">6.</span> <span class="nav-text">6.更新用户名</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">6.1.</span> <span class="nav-text">6.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">6.2.</span> <span class="nav-text">6.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.3.</span> <span class="nav-text">6.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.4.</span> <span class="nav-text">6.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E6%A3%80%E6%9F%A5%E7%94%A8%E6%88%B7%E5%AE%9E%E5%90%8D%E8%AE%A4%E8%AF%81"><span class="nav-number">7.</span> <span class="nav-text">7.检查用户实名认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">7.1.</span> <span class="nav-text">7.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">7.2.</span> <span class="nav-text">7.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.3.</span> <span class="nav-text">7.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.4.</span> <span class="nav-text">7.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%AE%9E%E5%90%8D%E8%AE%A4%E8%AF%81"><span class="nav-number">8.</span> <span class="nav-text">8.更新用户实名认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">8.1.</span> <span class="nav-text">8.1业务流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">8.2.</span> <span class="nav-text">8.2接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">8.3.</span> <span class="nav-text">8.3服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">8.4.</span> <span class="nav-text">8.4web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%B7%B2%E5%8F%91%E5%B8%83%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="nav-number">9.</span> <span class="nav-text">9 获取当前用户已发布房源信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4"><span class="nav-number">9.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3"><span class="nav-number">9.2.</span> <span class="nav-text">流程与接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">9.3.</span> <span class="nav-text">服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">9.4.</span> <span class="nav-text">web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E5%8F%91%E5%B8%83%E6%88%BF%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="nav-number">10.</span> <span class="nav-text">10 发布房源信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-1"><span class="nav-number">10.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-1"><span class="nav-number">10.2.</span> <span class="nav-text">流程与接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">10.3.</span> <span class="nav-text">服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E7%AB%AF%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">10.4.</span> <span class="nav-text">web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-%E4%B8%8A%E4%BC%A0%E6%88%BF%E5%B1%8B%E5%9B%BE%E7%89%87"><span class="nav-number">11.</span> <span class="nav-text">11 上传房屋图片</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-2"><span class="nav-number">11.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-2"><span class="nav-number">11.2.</span> <span class="nav-text">流程与接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0-2"><span class="nav-number">11.3.</span> <span class="nav-text">服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E7%AB%AF%E5%AE%9E%E7%8E%B0-2"><span class="nav-number">11.4.</span> <span class="nav-text">web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-%E8%8E%B7%E5%8F%96%E6%88%BF%E6%BA%90%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-number">12.</span> <span class="nav-text">12 获取房源详细信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-3"><span class="nav-number">12.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-3"><span class="nav-number">12.2.</span> <span class="nav-text">流程与接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0-3"><span class="nav-number">12.3.</span> <span class="nav-text">服务端实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web%E7%AB%AF%E5%AE%9E%E7%8E%B0-3"><span class="nav-number">12.4.</span> <span class="nav-text">web端实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-%E8%8E%B7%E5%8F%96%E9%A6%96%E9%A1%B5%E5%8A%A8%E7%94%BB%E5%9B%BE%E7%89%87"><span class="nav-number">13.</span> <span class="nav-text">13 获取首页动画图片</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-4"><span class="nav-number">13.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-4"><span class="nav-number">13.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14-%E6%90%9C%E7%B4%A2%E6%88%BF%E6%BA%90"><span class="nav-number">14.</span> <span class="nav-text">14 搜索房源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-5"><span class="nav-number">14.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-5"><span class="nav-number">14.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15-%E5%8F%91%E5%B8%83%E8%AE%A2%E5%8D%95"><span class="nav-number">15.</span> <span class="nav-text">15 发布订单</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-6"><span class="nav-number">15.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-6"><span class="nav-number">15.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16-%E8%AF%B7%E6%B1%82%E6%9F%A5%E7%9C%8B%E6%88%BF%E4%B8%9C-%E7%A7%9F%E5%AE%A2%E8%AE%A2%E5%8D%95%E4%BF%A1%E6%81%AF"><span class="nav-number">16.</span> <span class="nav-text">16 请求查看房东&#x2F;租客订单信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-7"><span class="nav-number">16.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-7"><span class="nav-number">16.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17-%E6%88%BF%E4%B8%9C%E5%90%8C%E6%84%8F-%E6%8B%92%E7%BB%9D%E8%AE%A2%E5%8D%95"><span class="nav-number">17.</span> <span class="nav-text">17 房东同意&#x2F;拒绝订单</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-8"><span class="nav-number">17.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-8"><span class="nav-number">17.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#18-%E7%94%A8%E6%88%B7%E8%AF%84%E4%BB%B7%E8%AE%A2%E5%8D%95%E4%BF%A1%E6%81%AF"><span class="nav-number">18.</span> <span class="nav-text">18 用户评价订单信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E4%BB%A4-9"><span class="nav-number">18.1.</span> <span class="nav-text">创建命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%8E%A5%E5%8F%A3-9"><span class="nav-number">18.2.</span> <span class="nav-text">流程与接口</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王增明</span>

  
</div>









        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  





  
  





  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
